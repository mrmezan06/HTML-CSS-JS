<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Income & Expense Tracker</title>
    <!-- Load Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom font for a clean look */
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f3f4f6; /* Light gray background */
      }
      /* Custom scrollbar for transaction list */
      #transactions-list::-webkit-scrollbar {
        width: 6px;
      }
      #transactions-list::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 3px;
      }
    </style>
    <!-- Load Lucide Icons for aesthetic appeal -->
    <script type="module">
      import {
        createIcons,
        PlusCircle,
        MinusCircle,
        Wallet,
        User,
      } from 'https://unpkg.com/lucide@latest';
      createIcons({ icons: { PlusCircle, MinusCircle, Wallet, User } });
    </script>
  </head>
  <body class="min-h-screen p-4 sm:p-8">
    <div id="app" class="max-w-4xl mx-auto">
      <header class="text-center mb-8">
        <div class="flex items-center justify-center text-indigo-700 mb-2">
          <i data-lucide="wallet" class="w-8 h-8 mr-2"></i>
          <h1 class="text-4xl font-extrabold tracking-tight">
            Financial Tracker
          </h1>
        </div>
        <p class="text-sm text-gray-500 font-medium">
          Powered by Firebase Firestore
        </p>
      </header>

      <!-- User Info and Loading State -->
      <div
        id="auth-status"
        class="bg-white p-3 rounded-lg shadow mb-4 text-center"
      >
        <p class="text-sm text-gray-600">
          <i
            data-lucide="user"
            class="w-4 h-4 inline-block mr-1 text-indigo-500"
          ></i>
          User ID:
          <span id="user-id" class="font-mono text-xs bg-gray-100 p-1 rounded"
            >Loading...</span
          >
        </p>
      </div>

      <!-- Balance and Summary Card -->
      <div
        class="bg-white p-6 rounded-xl shadow-lg mb-8 border-t-4 border-indigo-500"
      >
        <h2 class="text-lg font-semibold text-gray-700 mb-2">
          Current Balance
        </h2>
        <div class="flex items-end justify-between">
          <p
            id="current-balance"
            class="text-5xl font-extrabold text-gray-900 transition-colors duration-300"
          >
            $0.00
          </p>
          <div class="flex flex-col text-right space-y-1">
            <p
              id="total-income"
              class="text-xl font-bold text-green-600 flex items-center"
            >
              <i data-lucide="plus-circle" class="w-5 h-5 mr-1"></i>
              $0.00
            </p>
            <p
              id="total-expense"
              class="text-xl font-bold text-red-600 flex items-center"
            >
              <i data-lucide="minus-circle" class="w-5 h-5 mr-1"></i>
              $0.00
            </p>
          </div>
        </div>
      </div>

      <!-- Add Transaction Form -->
      <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
          Add New Transaction
        </h2>
        <form id="transaction-form" class="space-y-4">
          <!-- Description -->
          <input
            type="text"
            id="description"
            placeholder="Description (e.g., Salary, Rent)"
            required
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
          />

          <!-- Amount -->
          <input
            type="number"
            id="amount"
            placeholder="Amount (e.g., 50.00)"
            step="0.01"
            min="0.01"
            required
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
          />

          <!-- Type Selector -->
          <div class="flex space-x-4">
            <div
              class="flex items-center p-3 border border-green-500 rounded-lg w-1/2"
            >
              <input
                type="radio"
                id="income"
                name="type"
                value="Income"
                checked
                class="text-green-600 focus:ring-green-500"
              />
              <label for="income" class="ml-2 font-medium text-green-600"
                >Income</label
              >
            </div>
            <div
              class="flex items-center p-3 border border-red-500 rounded-lg w-1/2"
            >
              <input
                type="radio"
                id="expense"
                name="type"
                value="Expense"
                class="text-red-600 focus:ring-red-500"
              />
              <label for="expense" class="ml-2 font-medium text-red-600"
                >Expense</label
              >
            </div>
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            id="submit-btn"
            class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-xl shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out"
          >
            Record Transaction
          </button>
        </form>
        <div
          id="form-message"
          class="mt-3 text-center text-sm font-medium hidden"
        ></div>
      </div>

      <!-- Transaction History -->
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-bold text-gray-800 mb-4">History</h2>

        <!-- List Container -->
        <div
          id="transactions-list"
          class="max-h-96 overflow-y-auto divide-y divide-gray-100"
        >
          <p id="initial-loading" class="text-center text-gray-500 py-4">
            Loading transactions...
          </p>
          <!-- Transactions will be inserted here -->
        </div>

        <p id="no-transactions" class="text-center text-gray-500 py-4 hidden">
          No transactions recorded yet.
        </p>
      </div>
    </div>

    <!-- Firebase SDK Setup -->
    <script type="module">
      // Import necessary Firebase modules
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        onSnapshot,
        orderBy,
        serverTimestamp,
        setLogLevel,
        doc,
      } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

      // --- GLOBAL VARIABLES (Provided by Environment) ---
      const appId = '1:135151977753:web:10ba7b06c854820275b188';
      const firebaseConfig = {
        apiKey: 'AIzaSyAg8X77RZNmHj1tXUuvNfO7yDPtyZdNxhs',
        authDomain: 'incomeandexpense-5b20e.firebaseapp.com',
        projectId: 'incomeandexpense-5b20e',
        storageBucket: 'incomeandexpense-5b20e.firebasestorage.app',
        messagingSenderId: '135151977753',
        appId: '1:135151977753:web:10ba7b06c854820275b188',
        measurementId: 'G-RTHSQQWNFE',
      };
      const initialAuthToken =
        typeof __initial_auth_token !== 'undefined'
          ? __initial_auth_token
          : null;

      // --- Firebase Initialization ---
      let db;
      let auth;
      let userId = null;
      let isAuthReady = false;

      setLogLevel('Debug'); // Enable Firestore logging

      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);

      // --- UI Elements ---
      const transactionForm = document.getElementById('transaction-form');
      const descriptionInput = document.getElementById('description');
      const amountInput = document.getElementById('amount');
      const submitBtn = document.getElementById('submit-btn');
      const formMessage = document.getElementById('form-message');
      const currentBalanceEl = document.getElementById('current-balance');
      const totalIncomeEl = document.getElementById('total-income');
      const totalExpenseEl = document.getElementById('total-expense');
      const transactionsListEl = document.getElementById('transactions-list');
      const noTransactionsEl = document.getElementById('no-transactions');
      const initialLoadingEl = document.getElementById('initial-loading');
      const userIdEl = document.getElementById('user-id');

      /**
       * Determines the path to the user's private transaction collection.
       */
      function getTransactionPath() {
        if (!userId) {
          console.error('User ID is not available for path generation.');
          return null;
        }
        // Private data storage path: /artifacts/{appId}/users/{userId}/transactions
        return `artifacts/${appId}/users/${userId}/transactions`;
      }

      /**
       * Formats a number as a currency string.
       * @param {number} num - The number to format.
       * @returns {string} - Formatted currency string.
       */
      function formatCurrency(num) {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 2,
        }).format(num);
      }

      /**
       * Renders the transactions list and updates the balance summary.
       * @param {Array<Object>} transactions - The list of transaction documents.
       */
      function renderTransactions(transactions) {
        transactionsListEl.innerHTML = '';
        initialLoadingEl.classList.add('hidden');

        if (transactions.length === 0) {
          noTransactionsEl.classList.remove('hidden');
          transactionsListEl.classList.add('hidden');
        } else {
          noTransactionsEl.classList.add('hidden');
          transactionsListEl.classList.remove('hidden');

          let totalIncome = 0;
          let totalExpense = 0;

          transactions.forEach((t) => {
            const amount = parseFloat(t.amount);
            if (t.type === 'Income') {
              totalIncome += amount;
            } else {
              totalExpense += amount;
            }

            const isIncome = t.type === 'Income';
            const color = isIncome ? 'text-green-600' : 'text-red-600';
            const sign = isIncome ? '+' : '-';
            const iconType = isIncome ? 'plus-circle' : 'minus-circle';

            const listItem = document.createElement('div');
            listItem.className = `p-4 flex justify-between items-center transition duration-150 hover:bg-gray-50`;
            listItem.innerHTML = `
                        <div class="flex items-center">
                            <i data-lucide="${iconType}" class="w-5 h-5 mr-3 ${
              isIncome ? 'text-green-500' : 'text-red-500'
            }"></i>
                            <div>
                                <p class="font-medium text-gray-800">${
                                  t.description
                                }</p>
                                <p class="text-xs text-gray-400">
                                    ${
                                      t.timestamp
                                        ? new Date(
                                            t.timestamp.seconds * 1000
                                          ).toLocaleDateString()
                                        : 'N/A'
                                    }
                                </p>
                            </div>
                        </div>
                        <p class="font-bold text-lg ${color} text-right">
                            ${sign}${formatCurrency(amount)}
                        </p>
                    `;
            transactionsListEl.appendChild(listItem);
          });

          // Re-initialize lucide icons for the newly added elements
          import('https://unpkg.com/lucide@latest').then(
            ({ createIcons, PlusCircle, MinusCircle }) => {
              createIcons({
                icons: { PlusCircle, MinusCircle },
                attrs: { class: 'lucide-icon' },
              });
            }
          );

          // Update Summary
          const currentBalance = totalIncome - totalExpense;

          currentBalanceEl.textContent = formatCurrency(currentBalance);
          currentBalanceEl.classList.remove(
            'text-red-600',
            'text-green-600',
            'text-gray-900'
          );
          if (currentBalance < 0) {
            currentBalanceEl.classList.add('text-red-600');
          } else if (currentBalance > 0) {
            currentBalanceEl.classList.add('text-green-600');
          } else {
            currentBalanceEl.classList.add('text-gray-900');
          }

          totalIncomeEl.innerHTML = `<i data-lucide="plus-circle" class="w-5 h-5 mr-1"></i>${formatCurrency(
            totalIncome
          )}`;
          totalExpenseEl.innerHTML = `<i data-lucide="minus-circle" class="w-5 h-5 mr-1"></i>${formatCurrency(
            totalExpense
          )}`;
        }
      }

      /**
       * Sets up the real-time listener for transactions from Firestore.
       */
      function loadTransactions() {
        const path = getTransactionPath();
        if (!path) return;

        const transactionsQuery = query(
          collection(db, path),
          orderBy('timestamp', 'desc') // Sort by newest first
        );

        // Real-time listener
        onSnapshot(
          transactionsQuery,
          (snapshot) => {
            const transactions = [];
            snapshot.forEach((doc) => {
              transactions.push({ id: doc.id, ...doc.data() });
            });
            renderTransactions(transactions);
          },
          (error) => {
            console.error('Error listening to transactions: ', error);
            formMessage.textContent = 'Error loading data. Check console.';
            formMessage.className =
              'mt-3 text-center text-sm font-medium text-red-600';
            formMessage.classList.remove('hidden');
          }
        );
      }

      /**
       * Submits the transaction to Firestore.
       * @param {Event} e - Form submit event.
       */
      async function addTransaction(e) {
        e.preventDefault();

        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';
        formMessage.classList.add('hidden');

        const description = descriptionInput.value.trim();
        const amount = parseFloat(amountInput.value);
        const type = document.querySelector('input[name="type"]:checked').value;

        if (!description || isNaN(amount) || amount <= 0) {
          formMessage.textContent = 'Please check the description and amount.';
          formMessage.className =
            'mt-3 text-center text-sm font-medium text-red-600';
          formMessage.classList.remove('hidden');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Record Transaction';
          return;
        }

        const path = getTransactionPath();
        if (!path) {
          formMessage.textContent = 'Authentication failed. Cannot save.';
          formMessage.className =
            'mt-3 text-center text-sm font-medium text-red-600';
          formMessage.classList.remove('hidden');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Record Transaction';
          return;
        }

        const transactionData = {
          description: description,
          amount: amount,
          type: type,
          timestamp: serverTimestamp(), // Use server timestamp for consistency
        };

        try {
          // Exponential backoff retry logic
          for (let i = 0; i < 3; i++) {
            try {
              await addDoc(collection(db, path), transactionData);
              break; // Success
            } catch (error) {
              if (i === 2) throw error; // Re-throw if last retry failed
              await new Promise((resolve) =>
                setTimeout(resolve, 2 ** i * 1000)
              ); // Wait 1s, 2s, 4s
            }
          }

          // Clear the form only on success
          descriptionInput.value = '';
          amountInput.value = '';
          document.getElementById('income').checked = true; // Reset to Income

          formMessage.textContent = 'Transaction saved successfully!';
          formMessage.className =
            'mt-3 text-center text-sm font-medium text-green-600';
          formMessage.classList.remove('hidden');
        } catch (error) {
          console.error('Error adding document: ', error);
          formMessage.textContent =
            'Failed to save transaction: ' + error.message;
          formMessage.className =
            'mt-3 text-center text-sm font-medium text-red-600';
          formMessage.classList.remove('hidden');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Record Transaction';
        }
      }

      // --- Authentication Setup ---
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // User is signed in or successfully signed in
          userId = user.uid;
          isAuthReady = true;
          userIdEl.textContent = userId;
          loadTransactions(); // Start listening for data
          transactionForm.addEventListener('submit', addTransaction);
        } else {
          // Attempt to sign in
          try {
            if (initialAuthToken) {
              await signInWithCustomToken(auth, initialAuthToken);
            } else {
              const anonUser = await signInAnonymously(auth);
              userId = anonUser.user.uid;
              // On the next run of onAuthStateChanged, the app will proceed
            }
          } catch (error) {
            console.error('Firebase Auth Error:', error);
            userIdEl.textContent = 'AUTH ERROR';
            initialLoadingEl.textContent =
              'Authentication Failed. Check console.';
          }
        }
      });
    </script>
  </body>
</html>

<!-- 
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyAg8X77RZNmHj1tXUuvNfO7yDPtyZdNxhs",
    authDomain: "incomeandexpense-5b20e.firebaseapp.com",
    projectId: "incomeandexpense-5b20e",
    storageBucket: "incomeandexpense-5b20e.firebasestorage.app",
    messagingSenderId: "135151977753",
    appId: "1:135151977753:web:10ba7b06c854820275b188",
    measurementId: "G-RTHSQQWNFE"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
-->
